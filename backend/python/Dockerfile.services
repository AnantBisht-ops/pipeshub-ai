# Dockerfile for Python services with Python 3.10 (compatible with all dependencies)
FROM python:3.10-slim

WORKDIR /app

# Install system dependencies required for various Python packages
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    build-essential \
    curl \
    git \
    # For PostgreSQL packages
    libpq-dev \
    # For XML processing
    libxml2-dev \
    libxslt1-dev \
    # For cryptography
    libffi-dev \
    libssl-dev \
    # For image processing
    libpoppler-cpp-dev \
    # Clean up
    && rm -rf /var/lib/apt/lists/*

# Copy pyproject.toml first for better Docker layer caching
COPY pyproject.toml ./
COPY README.md ./

# Fix the langchain-voyageai version issue for Python 3.10
RUN sed -i 's/langchain-voyageai==0.1.6/langchain-voyageai==0.1.3/g' pyproject.toml

# Upgrade pip and install all dependencies
RUN pip install --upgrade pip setuptools wheel && \
    pip install -e . || echo "Some packages failed to install, continuing..."

# Copy the rest of the application code
COPY . .

# Set Python path
ENV PYTHONPATH=/app
ENV NODE_ENV=development
ENV LOG_LEVEL=debug

# The specific service to run will be specified in docker-compose via command
# No CMD here - it will be overridden by docker-compose