# Development Dockerfile - Optimized for faster builds and hot-reloading
FROM python:3.10-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    build-essential \
    curl \
    git \
    libpq-dev \
    libxml2-dev \
    libxslt1-dev \
    libffi-dev \
    libssl-dev \
    libpoppler-cpp-dev \
    # Add procps for debugging (ps, top commands)
    procps \
    # Add vim for quick edits
    vim \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip first
RUN pip install --upgrade pip setuptools wheel

# Install core dependencies first (these change less frequently)
RUN pip install \
    fastapi==0.115.6 \
    uvicorn[standard]==0.25.0 \
    pydantic==2.10.5 \
    python-dotenv==1.0.1 \
    aiohttp==3.12.14 \
    redis==5.2.1 \
    tenacity==8.5.0 \
    requests==2.32.4 \
    dependency_injector==4.44.0 \
    cachetools==5.3.2

# Copy only requirements/dependencies file first for better caching
COPY pyproject.toml ./
COPY README.md ./

# Fix the langchain-voyageai version issue for Python 3.10
RUN sed -i 's/langchain-voyageai==0.1.6/langchain-voyageai==0.1.3/g' pyproject.toml

# Install remaining dependencies in stages to avoid timeout
# Stage 1: Database and messaging dependencies
RUN pip install --no-cache-dir \
    python-arango==8.1.5 \
    aiokafka==0.12.0 \
    nats-py==2.1.0 \
    etcd3==0.12.0 \
    confluent-kafka==2.8.0 || echo "Some packages failed, continuing..."

# Stage 2: AI/ML dependencies (these are heavy)
RUN pip install --no-cache-dir \
    langchain==0.3.26 \
    langchain-openai==0.3.28 \
    langchain-community==0.3.27 \
    qdrant-client==1.13.1 || echo "Some ML packages failed, continuing..."

# Stage 3: Document processing
RUN pip install --no-cache-dir \
    PyMuPDF==1.24.14 \
    openpyxl==3.1.5 \
    python-docx==1.1.2 \
    beautifulsoup4==4.12.3 || echo "Some document packages failed, continuing..."

# Install essential dependencies that the services need to start
RUN pip install --no-cache-dir \
    pymongo \
    motor \
    httpx \
    pyyaml \
    jsonschema==4.23.0 \
    cryptography==44.0.1 \
    python-jose==3.4.0 \
    python-multipart==0.0.18 || echo "Some packages failed, continuing..."

# Install the rest of the dependencies with timeout handling
RUN timeout 900 pip install -e . || echo "Some packages failed to install, continuing..."

# Set Python path and environment variables
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Create a startup script for better error handling
RUN echo '#!/bin/bash\n\
echo "Container started successfully"\n\
echo "Python version: $(python --version)"\n\
echo "Working directory: $(pwd)"\n\
echo "Available services:"\n\
ls -la app/*_main.py 2>/dev/null || echo "Service files not mounted yet"\n\
exec "$@"' > /start.sh && chmod +x /start.sh

ENTRYPOINT ["/start.sh"]
CMD ["python", "--version"]