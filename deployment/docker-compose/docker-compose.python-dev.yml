version: '3.8'

services:
  # Connector Service - Development Mode with hot reload
  connector-service-dev:
    build:
      context: ../../backend/python
      dockerfile: Dockerfile.dev
    container_name: connector-service-dev
    ports:
      - "8088:8088"
    volumes:
      # Mount source code for hot-reloading
      - ../../backend/python:/app
      # Persist pip cache to speed up rebuilds
      - pip-cache:/root/.cache/pip
    environment:
      - SERVICE_NAME=connector
      - CONNECTOR_SERVICE_PORT=8088
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # Development mode with auto-reload
      - RELOAD=true
      - LOG_LEVEL=debug
      # Infrastructure connections (using host.docker.internal for local services)
      - ETCD_URL=http://host.docker.internal:2379
      - ETCD_HOST=host.docker.internal
      - ARANGO_URL=http://host.docker.internal:8529
      - ARANGO_DB_NAME=es
      - ARANGO_USERNAME=root
      - ARANGO_PASSWORD=F6ABRCb9qbRK1MhXNfkk
      - KAFKA_BROKERS=host.docker.internal:9092
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_PASSWORD=ARQ0yNS7uT70WPZr8yXC
      - REDIS_URL=redis://:ARQ0yNS7uT70WPZr8yXC@host.docker.internal:6379
      - MONGO_URI=mongodb://admin:uCmG7ABHKIKPX6MVnlFC@host.docker.internal:27017/?authSource=admin
      - MONGO_DB_NAME=es
      - QDRANT_HOST=host.docker.internal
      - QDRANT_API_KEY=UsoNzWEQHDrNOxDSp4z4zRyQ
      - QDRANT_GRPC_PORT=6334
      - QDRANT_PORT=6333
      - OLLAMA_API_URL=http://host.docker.internal:11434
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    # Use uvicorn with reload for development
    command: >
      sh -c "
      echo 'Starting Connector Service in development mode...' &&
      python -m uvicorn app.connectors_main:app --host 0.0.0.0 --port 8088 --reload --log-level debug
      "
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true

  # Indexing Service - Development Mode
  indexing-service-dev:
    build:
      context: ../../backend/python
      dockerfile: Dockerfile.dev
    container_name: indexing-service-dev
    depends_on:
      - connector-service-dev
    ports:
      - "8091:8091"
    volumes:
      - ../../backend/python:/app
      - pip-cache:/root/.cache/pip
    environment:
      - SERVICE_NAME=indexing
      - INDEXING_SERVICE_PORT=8091
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - RELOAD=true
      - LOG_LEVEL=debug
      - CONNECTOR_BACKEND=http://connector-service-dev:8088
      # Same infrastructure connections
      - ETCD_URL=http://host.docker.internal:2379
      - ETCD_HOST=host.docker.internal
      - ARANGO_URL=http://host.docker.internal:8529
      - ARANGO_DB_NAME=es
      - ARANGO_USERNAME=root
      - ARANGO_PASSWORD=F6ABRCb9qbRK1MhXNfkk
      - KAFKA_BROKERS=host.docker.internal:9092
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_PASSWORD=ARQ0yNS7uT70WPZr8yXC
      - REDIS_URL=redis://:ARQ0yNS7uT70WPZr8yXC@host.docker.internal:6379
      - MONGO_URI=mongodb://admin:uCmG7ABHKIKPX6MVnlFC@host.docker.internal:27017/?authSource=admin
      - MONGO_DB_NAME=es
      - QDRANT_HOST=host.docker.internal
      - QDRANT_API_KEY=UsoNzWEQHDrNOxDSp4z4zRyQ
      - QDRANT_GRPC_PORT=6334
      - QDRANT_PORT=6333
      - OLLAMA_API_URL=http://host.docker.internal:11434
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    command: >
      sh -c "
      echo 'Starting Indexing Service in development mode...' &&
      python -m uvicorn app.indexing_main:app --host 0.0.0.0 --port 8091 --reload --log-level debug
      "
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true

  # Query/AI Service - Development Mode
  query-service-dev:
    build:
      context: ../../backend/python
      dockerfile: Dockerfile.dev
    container_name: query-service-dev
    depends_on:
      - connector-service-dev
    ports:
      - "8000:8000"
    volumes:
      - ../../backend/python:/app
      - pip-cache:/root/.cache/pip
    environment:
      - SERVICE_NAME=query
      - QUERY_SERVICE_PORT=8000
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - RELOAD=true
      - LOG_LEVEL=debug
      - CONNECTOR_BACKEND=http://connector-service-dev:8088
      - INDEXING_BACKEND=http://indexing-service-dev:8091
      # Same infrastructure connections
      - ETCD_URL=http://host.docker.internal:2379
      - ETCD_HOST=host.docker.internal
      - ARANGO_URL=http://host.docker.internal:8529
      - ARANGO_DB_NAME=es
      - ARANGO_USERNAME=root
      - ARANGO_PASSWORD=F6ABRCb9qbRK1MhXNfkk
      - KAFKA_BROKERS=host.docker.internal:9092
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_PASSWORD=ARQ0yNS7uT70WPZr8yXC
      - REDIS_URL=redis://:ARQ0yNS7uT70WPZr8yXC@host.docker.internal:6379
      - MONGO_URI=mongodb://admin:uCmG7ABHKIKPX6MVnlFC@host.docker.internal:27017/?authSource=admin
      - MONGO_DB_NAME=es
      - QDRANT_HOST=host.docker.internal
      - QDRANT_API_KEY=UsoNzWEQHDrNOxDSp4z4zRyQ
      - QDRANT_GRPC_PORT=6334
      - QDRANT_PORT=6333
      - OLLAMA_API_URL=http://host.docker.internal:11434
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    command: >
      sh -c "
      echo 'Starting Query Service in development mode...' &&
      python -m uvicorn app.query_main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
      "
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true

volumes:
  pip-cache:
    driver: local